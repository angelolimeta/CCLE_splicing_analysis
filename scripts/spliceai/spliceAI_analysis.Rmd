---
title: "SpliceAI analysis - Variant classification"
output:
  html_document:
    df_print: paged
---

## Load libraries

```{r, message=FALSE, include=FALSE}
library(tidyverse)
library(readr)
library(data.table)
library(pROC)
library(PRROC)
library(hrbrthemes)
library(viridis)
library(MLeval)
select = dplyr::select
rename = dplyr::rename
```

```{r setup, include=FALSE, echo=FALSE}
require("knitr")
opts_knit$set(root.dir = "/Users/castilln/Desktop/thesis")
```


## Load parsed output
```{r}
##SPLICEAI PARSED OUTPUT
data = fread("localdata/spliceai/output/spliceAI_out.csv")
##CCLE MUTATIONS DATA
CCLE = fread("localdata/depmap/CCLE_info")
```


## Create unique ID for each SNP 
```{r}
##UNIQUE VARIABLE FOR SPLICEAI OUT
udata = data[, id_var := paste(ID, SYMBOL, POS, REF, ALT, sep = "_"), by = .(ID, SYMBOL, POS, REF, ALT)]

##UNIQUE VARIABLE FOR CCLE DATA
uccle = CCLE[, id_var := paste(stripped_cell_line_name, Hugo_Symbol, Start_position, Reference_Allele, Tumor_Seq_Allele1, sep = "_"), by = .(stripped_cell_line_name, Hugo_Symbol, Start_position, Reference_Allele, Tumor_Seq_Allele1)]
```


## Threshold
Find max probability 
```{r, warning=FALSE}
###CREATE A NEW COLUMN WITH THE HIGHEST PROBABILITY

##TURN SCORE COLUMNS INTO NUMERIC VARIABLES
#SELECT SCORE COLUMNS
score_col = 
  udata %>% 
  select(contains("SCORE")) 

#SELECT COLUMN NAMES
cols.num <- colnames(score_col)

#CONVERT INTO NUMERIC
udata = as.data.frame(udata)
udata[cols.num] <- sapply(udata[cols.num],as.numeric)

##SELECT MAX PROBABILITY FROM SPLICEAI OUTPUT
max_data =
  udata %>% 
  mutate(MAX_PROBABILITY = apply(X = data[,10:13], MARGIN = 1, FUN = max)) %>% 
  drop_na(MAX_PROBABILITY)

```


## Annotation
Let's see which mutations had already been annotated as splice variants in the CCLE
```{r}
## GET LIST OF ALL VARIANT ANNOTATIONS
CCLE %>% 
  pull(Variant_Classification) %>% 
  unique()

## GET ANNOTATION COLUMNS
ann_ccle = 
uccle %>%  
  select(Hugo_Symbol, CCLE_Name, Variant_Classification, Variant_annotation, id_var, primary_disease)

## FILTER FOR THOSE CLASSIFIED AS ALTERING A SPLICE SITE
CCLE_splice = 
  CCLE %>% 
    filter(Variant_Classification == "Splice_Site")
```

Join CCLE annotation with spliceAI output
```{r}
## JOIN BY HUGO SYMBOL AND CELL LINE NAME
ann_data = 
  max_data %>% 
  left_join(ann_ccle, by = "id_var") %>% 
  select(-c("Hugo_Symbol", "QUAL", "FILTER", "CCLE_Name")) #drop unnecessary variables
```


## Prepare data for ROC curves
```{r}
## GIVE SPLICE SITE 1 AND EVERYTHING ELSE 0 
roc_data = 
  ann_data %>% 
  mutate(splice_altering = case_when(
    Variant_Classification == "Splice_Site" ~ 1, 
    Variant_Classification != "Splice_Site" ~ 0
  )) %>% 
  mutate(MAX_PROBABILITY = as.numeric(MAX_PROBABILITY)) %>% 
  drop_na()

head(roc_data)
```

## ROC curve
AUC: Area Under the Curve
```{r}
rocobj <- roc(response = roc_data$splice_altering, predictor = roc_data$MAX_PROBABILITY, partial.auc.correct = TRUE, percent = TRUE)

## PLOT 
plot.roc(rocobj, print.auc = TRUE)
```

## PRECISION RECALL CURVE

```{r}
pr <- pr.curve(roc_data$MAX_PROBABILITY,roc_data$splice_altering, curve = T, max.compute = TRUE, 
  min.compute = TRUE, rand.compute = TRUE)

plot(pr, max.plot = TRUE, min.plot = TRUE, rand.plot = TRUE, fill.area = TRUE)
```

## Contingency table
```{r}
cont_data = 
  roc_data %>% 
  mutate(predictor = case_when(
    MAX_PROBABILITY >= 0.8 ~ "Max prob >= 0.8",
    MAX_PROBABILITY < 0.8 ~ "Max prob < 0.8"
  )) %>% 
  mutate(pred_splice_altering = case_when(
    splice_altering == 1 ~ "Not annotated", 
    splice_altering == 0 ~ "Annotated splice altering"
  ))
```


```{r}
cont = table(distinct(cont_data)$predictor,distinct(cont_data)$pred_splice_altering)

cont[2:1, 1:2]
```


## Violin plots
Function to produce data statistics
```{r}
data_summary <- function(x) {
   m <- mean(x)
   ymin <- m-sd(x)
   ymax <- m+sd(x)
   return(c(y=m,ymin=ymin,ymax=ymax))
}
```


Data distribution
```{r, fig.width=3, fig.height=2}
##BOXPLOTS  
roc_data = 
  roc_data %>% 
    mutate(splice_altering = as.factor(splice_altering)) 


ggplot(data = roc_data, aes(x = splice_altering, y = MAX_PROBABILITY)) +
  geom_violin(trim = F) + 
  scale_y_log10() +
  theme_bw() +
  theme( 
        axis.ticks.x = element_blank(),
        legend.position = "bottom",
        plot.title = element_text(face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        ) +
  scale_x_discrete(labels=c("0" = "NO", "1" = "YES")) +
  ylab("Predicted probability of being a splice altering mutation") + 
  xlab("Splice altering") +
  stat_summary(fun.data = data_summary)


```


## Analyze prediction for each disease

```{r, fig.width=7, fig.height=6, warning=FALSE}
## EXCLUDE DATA FROM UNKNOWN OR NOT-CANCEROUS CELL LINES AND FROM ADRENAL CANCER (1 CELL LINE)
data_all_cancers = 
  select(filter(roc_data, primary_disease != "Unknown" & primary_disease != "Non-Cancerous" & primary_disease != "Adrenal Cancer"), c("primary_disease", "MAX_PROBABILITY", "splice_altering")) %>% 
  mutate(splice_altering = as.factor(splice_altering))

## MAKE SURE SPLICE_ALTERING IS A FACTOR
ggplot(data = data_all_cancers, aes(x = splice_altering, y = MAX_PROBABILITY, fill = splice_altering)) +
  geom_violin(trim = F) +
  geom_jitter(size=0.001) +
  scale_y_log10() +
  facet_wrap(facets = "primary_disease") +
  #facet_grid(. ~ primary_disease) +
  scale_fill_viridis(discrete=T, name="Annotated as splice-altered variants based on RNA-Seq data", labels = c("NO", "YES")) +
  theme_bw() +
  theme(axis.text.x = element_blank(), 
        axis.ticks.x = element_blank(),
        legend.position = "bottom",
        plot.title = element_text(face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        ) +
  scale_x_discrete(labels=c("0" = "NO", "1" = "YES")) +
  ylab("Predicted log probability of being a splice altering mutation") + 
  xlab("") +
  geom_hline(yintercept=0.5, linetype="dashed", color = "red") +
  stat_summary(fun.data = data_summary)
```

```{r, include=FALSE}
ggsave("figures/results/spliceai/spliceai_viz_probabilities_jitter.png", width = 10, height = 10)
```


## Set  threshold and prepare table to present data
Select information of interest from CCLE_splice
```{r}
meta = 
  uccle %>% 
  select(c("DepMap_ID", "Annotation_Transcript", "id_var"))
```

Threshold at 0.5 

```{r}
ths5 = 
  ann_data %>% 
  filter(MAX_PROBABILITY >= 0.5) %>% 
  select(-c("INFO", "Variant_annotation")) %>%
  left_join(meta, by = "id_var") %>% 
  relocate(DepMap_ID)


head(ths5)
```
```{r}
saveRDS(ths5, file="github/results/spliceAI/ths5.rds")
```

Threshold at 0.8 (max probability)
```{r}
ths8 = 
  ann_data %>% 
  filter(MAX_PROBABILITY >= 0.8) %>% 
  select(-c("INFO", "Variant_annotation")) %>%
  left_join(meta, by = "id_var") %>% 
  relocate(DepMap_ID)


head(ths8)
```

```{r}
saveRDS(ths8, file="github/results/spliceAI/ths8.rds")
```


Filter those SNPs without DepMap ID
```{r}
noID = 
  ths8 %>% 
  filter(is.na(DepMap_ID)) %>% 
  select(-c("Variant_Classification", "primary_disease", "Annotation_Transcript")) %>% 
  rename("CELL_LINE" = "ID")
```

Generate a list of primary disease based on cell line name
```{r}
disease = 
  CCLE %>% 
  select(c("stripped_cell_line_name", "primary_disease")) %>% 
  distinct() %>% 
  rename("CELL_LINE" = "stripped_cell_line_name", 
         "DISEASE" = "primary_disease")
```

Add disease information to SNPs w/o DepMapID
```{r}
noID = 
  noID %>% 
  left_join(disease, by = "CELL_LINE") %>% 
  arrange(desc(MAX_PROBABILITY))
```

```{r}
head(noID)
```


Get SNPs in leukemia cell lines
```{r}
noID %>% 
  filter(DISEASE.x  == "Pancreatic Cancer")
```
Let's try to relate each new predicted SNP with the SNP from CCLE
```{r}
CCLE %>% 
  filter(stripped_cell_line_name == "L33")
```


Let's try to verify that those alterations predicted by spliceAI that lack a DepMap ID are not present in the mutations df
```{r}
head(CCLE_mutations)
```



