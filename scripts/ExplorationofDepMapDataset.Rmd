---
title: "Exploration of CLL dataset"
output: html_notebook
---

load libraries
```{r, message=FALSE, include=FALSE}
library(tidyverse)
library(readr)
library(biomaRt)
library(cowplot)
library(ggpubr)
library(data.table)
library(ggsci)
library(ggrepel)
library(ggExtra)
library(hrbrthemes)
library(wesanderson)
library(EDASeq)
select = dplyr::select
count = dplyr::count
```

load data
```{r, message=FALSE, include=FALSE}
CCLE_mutations <- read_delim("../data/CCLE_mutations.csv", 
    "\t", escape_double = FALSE, trim_ws = TRUE)
#head(CCLE_mutations)

sample_info <- read_csv("../data/sample_info.csv")
#head(sample_info)
```

merge both datasets (by DepMap_ID)
```{r}
joined_CCLE <- right_join(CCLE_mutations, sample_info, by = "DepMap_ID", copy = TRUE, suffix = c(".CCL", ".info"))
```
export to csv
```{r}
#write.csv(joined_CCLE,"/Users/castilln/Desktop/thesis/localdata/CCLE_info", row.names = FALSE)
```

Distribution of cancer types across cell lines
```{r}
ggplot(data=joined_CCLE) +
  geom_bar(mapping = aes(x = primary_disease, fill = primary_or_metastasis)) +
  xlab(NULL) + 
  ylab(NULL) + 
  labs(fill = "Primary or Metastasis") + 
  ggtitle("Number of primary and metastatic cancer in each cell line") +
  theme_bw() +
  theme(axis.text.x = element_blank(), 
        axis.ticks.x = element_blank(),
        legend.position = "bottom",
        plot.title = element_text(face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        ) +
  scale_fill_manual(values = wes_palette("GrandBudapest1", n = 3, type = "discrete"),na.value ="grey") +
  coord_flip() 
  #(axis.text.x = element_text(angle = 90)) +       #rotate the label
 
```

Repeat the plot above with counts normalized by number of cell lines studied
```{r}
#count observed mutations per cell line
cell_lines_studied <- joined_CCLE %>% 
  group_by(primary_disease) %>% count(CCLE_Name) %>% rename("n" = "observed_mutations")

#count the number of cell lines per cancer type 
normalize <- cell_lines_studied %>% 
  count(primary_disease) %>% rename("n" = "cell_lines_number")

#observed mutations across the cell lines
cell_lines_distribution <- cell_lines_studied %>% 
  count(primary_disease, wt = observed_mutations) %>% rename("n" = "observed_mutation_all_cell_lines") 

```

Show distribution of cell lines across the different cancer types (how many cell lines have been studied per cancer)
```{r}
ggplot(data = cell_lines_studied) +
  geom_bar(mapping = aes(x = primary_disease))+ 
  xlab(NULL) + 
  ylab("Number of cell lines studied")+ 
  ggtitle("Number of primary and metastatic cancer in each cell line") +
  theme_bw() +
  theme(axis.text.x = element_blank(), 
        axis.ticks.x = element_blank(),
        legend.position = "bottom",
        plot.title = element_text(face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        ) +
  #scale_color_manual(values = wes_palette("GrandBudapest1", n = 1, type = "discrete"),na.value ="grey") +
  coord_flip() 
 
```


```{r}
cell_lines_distribution <- right_join(cell_lines_distribution, normalize, by = "primary_disease", copy = TRUE)

cell_lines_distribution %>% 
  mutate(normalized_mutations = observed_mutation_all_cell_lines / cell_lines_number) -> cell_lines_distribution

ggplot(data = cell_lines_distribution) +
  geom_col(mapping = aes(x = primary_disease, y = normalized_mutations)) + 
  coord_flip() + 
  xlab(NULL) + 
  ylab("Observed mutations normalized for cell lines studied")
```

Subset pancreatic cancer, cell lines used
```{r}
joined_CCLE %>% 
  filter(primary_disease == "Pancreatic Cancer") -> pancreatic_cancer

head(pancreatic_cancer)
```

Retrieve database with HUGO symbol nomenclature 
```{r}
#ensembl <- useMart("ensembl")
#datasets <- listDatasets(ensembl)
#view(datasets)

ensembl <- useMart("ensembl", dataset = "hsapiens_gene_ensembl") 

#get list of all available filters
#filters <- listFilters(ensembl) 

```


Fetch gene symbols, to be used instead of gene ensembl id
```{r}
#create vector with the Hugo Symbols that we want
id_list = joined_CCLE %>% 
  select(Hugo_Symbol) %>% 
  distinct() %>% 
  pull(Hugo_Symbol)

#gene list with hugo symbol and entrez id / ensembl id 
genes_list <- getBM(filters= "hgnc_symbol", attributes= c("ensembl_gene_id",
"hgnc_symbol", "description"), values = id_list, uniqueRows = TRUE, mart = useDataset("hsapiens_gene_ensembl", useMart("ensembl")))
```

normalize the amount of mutations by length of the gene
```{r}
#count mutations per gene and cancer
joined_CCLE %>% 
  group_by(Hugo_Symbol, primary_disease) %>% tally() %>% 
  rename("n" = "nr of mutations") -> mut_per_gene_cancer 

ensembl_list <- genes_list %>% 
  pull(ensembl_gene_id) %>% 
  as_vector()

#retrieve gene length and gc content 
length <- getGeneLengthAndGCContent(ensembl_list, "hsa")
as.data.frame(length) -> length

#transform rows into variable
setDT(length, keep.rownames = "ensembl_gene_id")[]

#merge length and gc content with hugo symbol & gene info
right_join(genes_list, length, by = "ensembl_gene_id", copy = TRUE) %>% 
  select(hgnc_symbol, length) %>% 
  rename("hgnc_symbol" = "Hugo_Symbol")-> gene_lenght_list

left_join(mut_per_gene_cancer, gene_lenght_list, by="Hugo_Symbol") %>% 
  mutate(norm_mutations = `nr of mutations`/length) -> norm_mut_per_gene_cancer

```

find most mutated genes per cancer
```{r}
norm_mut_per_gene_cancer %>% 
  arrange(desc(norm_mutations)) %>%
  group_by(primary_disease) %>% 
  top_n(3) %>% 
  ggplot(aes(x = primary_disease, y = norm_mutations, fill = Hugo_Symbol)) +
  geom_col() + 
  #geom_text(aes(label = Hugo_Symbol)) +
  coord_flip() + 
  xlab(NULL) + 
  ylab("Most mutated genes per cancer")
```
most mutated genes across all cancers
```{r}
joined_CCLE %>% 
  filter(Variant_Classification!= "Silent") %>% 
  group_by(Hugo_Symbol) %>% 
  tally() %>% 
  rename("n" = "observed_mutations") %>% 
  left_join(gene_lenght_list, by = "Hugo_Symbol") %>% 
  mutate(normalized_mutations = observed_mutations/length) %>% 
  arrange(desc(normalized_mutations)) %>% 
  top_n(50) -> most_mutated_genes

most_mutated_genes %>% 
  ggplot(aes(x = reorder(Hugo_Symbol, normalized_mutations), y = normalized_mutations)) +
  geom_col() +
  coord_flip() +
  theme_bw()+ 
  xlab(NULL) +
  ylab("Most mutated genes across cancer cell lines")

```

